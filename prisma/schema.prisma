generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// AUTH MODULE MODELS
// ============================================

model User {
  id                    Int         @id @default(autoincrement())
  password              String
  createdAt             DateTime    @default(now())
  email                 String      @unique
  name                  String
  phoneNumber           String?
  roleId                Int?
  isActive              Boolean     @default(true)
  lastLoggedInOn        DateTime?
  requirePasswordReset  Boolean     @default(false)
  lastPasswordChangedOn DateTime    @default(now())
  role                  Role?       @relation(fields: [roleId], references: [id])
  customer              Customer?
  createdPesticides     Pesticide[] @relation("CreatedBy")
  updatedPesticides     Pesticide[] @relation("LastUpdatedBy")
}

model Role {
  id              Int              @id @default(autoincrement())
  name            String           @unique
  createdAt       DateTime         @default(now())
  createdById     Int?
  isActive        Boolean          @default(false)
  lastUpdatedAt   DateTime?
  lastUpdatedById Int?
  permissions     RolePermission[]
  users           User[]
}

model Permission {
  id    Int              @id @default(autoincrement())
  name  String           @unique
  roles RolePermission[]
}

model RolePermission {
  id           Int        @id @default(autoincrement())
  roleId       Int
  permissionId Int
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)

  @@unique([roleId, permissionId])
}

// ============================================
// CONFIGS MODULE MODELS
// ============================================

model Pesticide {
  id                       Int       @id @default(autoincrement())
  registrationNumber       String    @unique
  activeAgent              String
  manufacturerOfRegistrant String
  localAgent               String
  published                Boolean   @default(false)
  createdAt                DateTime  @default(now())
  lastUpdatedAt            DateTime?
  createdById              Int?
  lastUpdatedById          Int?
  name                     String    @unique
  createdBy                User?     @relation("CreatedBy", fields: [createdById], references: [id])
  lastUpdatedBy            User?     @relation("LastUpdatedBy", fields: [lastUpdatedById], references: [id])
}

model Pest {
  id              Int       @id @default(autoincrement())
  name            String    @unique
  scientificName  String    @unique
  kingdom         String
  phylum          String?
  genus           String
  family          String
  published       Boolean   @default(false)
  createdAt       DateTime  @default(now())
  lastUpdatedAt   DateTime?
  createdById     Int?
  lastUpdatedById Int?
}

model County {
  id              Int       @id @default(autoincrement())
  name            String    @unique
  isActive        Boolean   @default(false)
  createdAt       DateTime  @default(now())
  lastUpdatedAt   DateTime?
  createdById     Int?
  lastUpdatedById Int?
}

model ServiceType {
  id              Int       @id @default(autoincrement())
  name            String    @unique
  description     String
  isActive        Boolean   @default(false)
  createdAt       DateTime  @default(now())
  lastUpdatedAt   DateTime?
  createdById     Int?
  lastUpdatedById Int?
}

model Crop {
  id              Int       @id @default(autoincrement())
  name            String    @unique
  scientificName  String?
  description     String?
  isActive        Boolean   @default(false)
  createdAt       DateTime  @default(now())
  lastUpdatedAt   DateTime? @updatedAt
  createdById     Int?
  lastUpdatedById Int?
}

// ============================================
// ACADEMIC SUITE MODULE MODELS
// ============================================

model Customer {
  id              Int      @id @default(autoincrement())
  companyLogo     String?
  companyName     String
  contactPerson   String
  phoneNumber     String
  emailAddress    String   @unique
  numberOfSchools Int      @default(0)
  isActive        Boolean  @default(true)
  userId          Int?     @unique
  user            User?    @relation(fields: [userId], references: [id])
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  schools         School[]
}

model School {
  id              String         @id @default(uuid())
  name            String
  schoolId        String         @unique
  email           String?
  phoneNumber     String?
  address         String?
  principalName   String?
  principalPhone  String?
  principalEmail  String?
  customerId      Int?
  customer        Customer?      @relation(fields: [customerId], references: [id], onDelete: Cascade)
  logo            String?
  latitude        String?
  longitude       String?
  url             String?
  isActive        Boolean        @default(true)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdById     Int?
  lastUpdatedById Int?
  buses           Bus[]
  schoolDrivers   SchoolDriver[]
  schoolMinders   SchoolMinder[]
  schoolParents   SchoolParent[]
  students        Student[]
  routes          Route[]

  @@map("schools")
}

model SchoolDriver {
  id              String       @id @default(uuid())
  name            String
  phoneNumber     String
  schoolId        String
  school          School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  photo           String?
  pin             String       @unique
  status          String       @default("Active")
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  createdById     Int?
  lastUpdatedById Int?
  routes          Route[]
  schoolTrips     SchoolTrip[]

  @@map("school_drivers")
}

model SchoolMinder {
  id              String       @id @default(uuid())
  name            String
  phoneNumber     String
  schoolId        String
  school          School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  photo           String?
  pin             String       @unique
  status          String       @default("Active")
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  createdById     Int?
  lastUpdatedById Int?
  routes          Route[]
  schoolTrips     SchoolTrip[]

  @@map("school_minders")
}

model SchoolParent {
  id              String          @id @default(uuid())
  name            String
  parentType      String
  phoneNumber     String
  email           String?
  status          String          @default("Active")
  isActive        Boolean         @default(true)
  schoolId        String
  school          School          @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  createdById     Int?
  lastUpdatedById Int?
  students        Student[]
  addresses       ParentAddress[]

  @@map("school_parents")
}

model Student {
  id                 String                @id @default(uuid())
  name               String
  admissionNumber    String                @unique
  dateOfBirth        String
  gender             String
  status             String                @default("Active")
  specialNeeds       String[]              @default([])
  medicalInfo        String?
  rfidTagId          String?
  photo              String?
  isActive           Boolean               @default(true)
  schoolId           String
  school             School                @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  parentId           String
  parent             SchoolParent          @relation(fields: [parentId], references: [id], onDelete: Cascade)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  createdById        Int?
  lastUpdatedById    Int?
  routeStudents      RouteStudent[]
  schoolTripStudents SchoolTripStudent[]
  rfidEvents         SchoolTripRfidEvent[]

  @@map("students")
}

model ParentAddress {
  id              String       @id @default(uuid())
  addressType     String
  location        String
  longitude       Float?
  latitude        Float?
  status          String       @default("Active")
  isPrimary       Boolean      @default(false)
  parentId        String
  parent          SchoolParent @relation(fields: [parentId], references: [id], onDelete: Cascade)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  createdById     Int?
  lastUpdatedById Int?

  @@map("parent_addresses")
}

model Bus {
  id                 String       @id @default(uuid())
  registrationNumber String       @unique
  schoolId           String
  school             School       @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  make               String
  model              String
  seatsCapacity      Int
  type               String
  status             String       @default("Active")
  isActive           Boolean      @default(true)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  createdById        Int?
  lastUpdatedById    Int?
  routes             Route[]
  schoolTrips        SchoolTrip[]

  @@map("buses")
}

model Route {
  id              String         @id @default(uuid())
  name            String
  schoolId        String
  school          School         @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  tripType        TripType
  description     String?
  status          String         @default("Active")
  isActive        Boolean        @default(true)
  busId           String?
  bus             Bus?           @relation(fields: [busId], references: [id], onDelete: SetNull)
  driverId        String?
  driver          SchoolDriver?  @relation(fields: [driverId], references: [id], onDelete: SetNull)
  minderId        String?
  minder          SchoolMinder?  @relation(fields: [minderId], references: [id], onDelete: SetNull)
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  createdById     Int?
  lastUpdatedById Int?
  routeStudents   RouteStudent[]
  schoolTrips     SchoolTrip[]

  @@map("routes")
}

model RouteStudent {
  id        String    @id @default(uuid())
  routeId   String
  route     Route     @relation(fields: [routeId], references: [id], onDelete: Cascade)
  studentId String
  student   Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  riderType RiderType @default(DAILY)
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@unique([routeId, studentId])
  @@map("route_students")
}

model SchoolTrip {
  id                 String                @id @default(uuid())
  routeId            String
  route              Route                 @relation(fields: [routeId], references: [id], onDelete: Cascade)
  busId              String?
  bus                Bus?                  @relation(fields: [busId], references: [id], onDelete: SetNull)
  driverId           String?
  driver             SchoolDriver?         @relation(fields: [driverId], references: [id], onDelete: SetNull)
  minderId           String?
  minder             SchoolMinder?         @relation(fields: [minderId], references: [id], onDelete: SetNull)
  tripDate           DateTime
  scheduledStartTime DateTime
  actualStartTime    DateTime?
  scheduledEndTime   DateTime?
  actualEndTime      DateTime?
  status             SchoolTripStatus      @default(SCHEDULED)
  notes              String?
  startLocation      String?
  endLocation        String?
  startGps           String?
  endGps             String?
  isActive           Boolean               @default(true)
  createdAt          DateTime              @default(now())
  updatedAt          DateTime              @updatedAt
  createdById        Int?
  lastUpdatedById    Int?
  tripStudents       SchoolTripStudent[]
  rfidEvents         SchoolTripRfidEvent[]

  @@map("school_trips")
}

model SchoolTripStudent {
  id                   String                @id @default(uuid())
  tripId               String
  trip                 SchoolTrip            @relation(fields: [tripId], references: [id], onDelete: Cascade)
  studentId            String
  student              Student               @relation(fields: [studentId], references: [id], onDelete: Cascade)
  pickupStatus         PickupDropoffStatus   @default(NOT_PICKED_UP)
  dropoffStatus        PickupDropoffStatus   @default(NOT_DROPPED_OFF)
  scheduledPickupTime  DateTime?
  actualPickupTime     DateTime?
  scheduledDropoffTime DateTime?
  actualDropoffTime    DateTime?
  pickupLocation       String?
  dropoffLocation      String?
  pickupGps            String?
  dropoffGps           String?
  notes                String?
  isActive             Boolean               @default(true)
  createdAt            DateTime              @default(now())
  updatedAt            DateTime              @updatedAt
  rfidEvents           SchoolTripRfidEvent[]

  @@unique([tripId, studentId])
  @@map("school_trip_students")
}

model SchoolTripRfidEvent {
  id             String            @id @default(uuid())
  tripId         String
  trip           SchoolTrip        @relation(fields: [tripId], references: [id], onDelete: Cascade)
  tripStudentId  String
  tripStudent    SchoolTripStudent @relation(fields: [tripStudentId], references: [id], onDelete: Cascade)
  studentId      String
  student        Student           @relation(fields: [studentId], references: [id], onDelete: Cascade)
  eventType      RfidEventType
  rfidTagId      String // RFID tag identifier
  deviceId       String? // RFID reader device ID
  deviceLocation String? // Location of the RFID reader (e.g., "Front Door", "Back Door")
  gpsCoordinates String? // GPS coordinates when scan occurred
  scannedAt      DateTime          @default(now())
  notes          String?
  createdAt      DateTime          @default(now())

  @@index([tripId])
  @@index([studentId])
  @@index([scannedAt])
  @@map("school_trip_rfid_events")
}

// ============================================
// FLEET MODULE MODELS
// ============================================

model Vehicle {
  id                     Int           @id @default(autoincrement())
  make                   String
  model                  String
  licensePlate           String        @unique
  vin                    String        @unique
  year                   Int
  color                  String?
  fuelType               String?
  mileage                Int?
  registrationExpiry     DateTime?
  isActive               Boolean       @default(true)
  notes                  String?
  createdAt              DateTime      @default(now())
  lastUpdatedAt          DateTime      @updatedAt
  createdById            Int?
  lastUpdatedById        Int?
  averageFuelConsumption Float?
  pricePerKm             Float?
  maintenances           Maintenance[]
  trips                  Trip[]
}

model Driver {
  id                 Int       @id @default(autoincrement())
  firstName          String
  middleName         String?
  lastName           String
  email              String    @unique
  phoneNumber        String
  licenseNumber      String    @unique
  licenseExpiry      DateTime
  dateOfBirth        DateTime?
  address            String?
  emergencyContact   String?
  emergencyPhone     String?
  isActive           Boolean   @default(true)
  notes              String?
  createdAt          DateTime  @default(now())
  lastUpdatedAt      DateTime  @updatedAt
  createdById        Int?
  lastUpdatedById    Int?
  driverLicensePhoto String?
  gender             String
  idPhoto            String?
  nationalId         String    @unique
  passportPhoto      String?
  psvLicenseDoc      String?
  trips              Trip[]
}

model Maintenance {
  id               Int       @id @default(autoincrement())
  vehicleId        Int
  maintenanceType  String
  description      String
  scheduledDate    DateTime
  completedDate    DateTime?
  cost             Float?
  serviceProvider  String?
  invoiceNumber    String?
  isCompleted      Boolean   @default(false)
  notes            String?
  mileageAtService Int?
  createdAt        DateTime  @default(now())
  lastUpdatedAt    DateTime  @updatedAt
  createdById      Int?
  lastUpdatedById  Int?
  vehicle          Vehicle   @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
}

model Trip {
  id              Int           @id @default(autoincrement())
  vehicleId       Int
  driverId        Int
  startTime       DateTime
  endTime         DateTime?
  purpose         String
  notes           String?
  createdAt       DateTime      @default(now())
  lastUpdatedAt   DateTime      @updatedAt
  createdById     Int?
  lastUpdatedById Int?
  customerName    String?
  customerPhone   String?
  distance        Float?
  feedback        String?
  fuelConsumption Float?
  fuelCost        Float?
  paymentMethod   String?
  paymentStatus   PaymentStatus @default(PENDING)
  pricePerKm      Float
  rating          Int?
  totalPrice      Float?
  status          TripStatus    @default(SCHEDULED)
  endGps          String?
  startGps        String
  driver          Driver        @relation(fields: [driverId], references: [id], onDelete: Cascade)
  vehicle         Vehicle       @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
}

// ============================================
// ENUMS
// ============================================

enum TripStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  ON_HOLD
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIAL
  REFUNDED
  CANCELLED
}

enum TripType {
  MORNING_PICKUP
  EVENING_DROPOFF
  FIELD_TRIP
  EXTRA_CURRICULUM
  EMERGENCY
}

enum RiderType {
  DAILY
  OCCASIONAL
}

enum SchoolTripStatus {
  SCHEDULED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  DELAYED
}

enum PickupDropoffStatus {
  NOT_PICKED_UP
  PICKED_UP
  NOT_DROPPED_OFF
  DROPPED_OFF
  ABSENT
  EXCUSED
}

enum RfidEventType {
  ENTERED_BUS
  EXITED_BUS
}
